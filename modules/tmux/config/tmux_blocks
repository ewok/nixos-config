#! /bin/bash

usbmon() {
	i=1
	#for usb in $(\df -Th | awk '/s[a-z][a-z][0-9]/ && $7!="/" {print substr($1,6)}')
	for usb in $(\lsblk -do name,tran | awk '$2=="usb" {print $1}'); do
		[[ $i -le 1 ]] && printf "#[fg=#5E81AC]ïŠ‡  $usb"
		[[ $i -gt 1 ]] && printf " $usb"
		let "i+=1"
	done
}

network() {
	# get first element
	conntype=$(ip route | awk '/default/ { print substr($5,1,2) }' | head -1)

	if [ -z "$conntype" ]; then
		echo -e "#[fg=#d75f5f]ï‡« ï‚« "
	elif [ "$conntype" = "et" ]; then
		echo -e "#[fg=#83A589]ïƒ¨ ï‚ª "
	elif [ "$conntype" = "wl" ] || [ "$conntype" = "en" ]; then
		echo -e "#[fg=#83A589]ï‡« "
	fi
}

battery() {
	for battery in /sys/class/power_supply/BAT?*; do
		[ -n "${capacity+x}" ] && printf " "
		case "$(cat "$battery/status" 2>&1)" in
		"Full") status="âš¡" ;;
		"Discharging") status="D" ;;
		"Charging") status="ğŸ”Œ" ;;
		"Not charging") status="!ï‰€  " ;;
		"Unknown") status="â™»ï¸  " ;;
		*) exit 1 ;;
		esac
		capacity="$(cat "$battery/capacity" 2>&1)"
		if [[ "$status" = "D" ]]; then
			if [[ "$capacity" -ge 85 ]]; then
				status="#[fg=#00FF00]ğŸ”‹"
			elif [[ "$capacity" -le 85 ]] && [[ "$capacity" -ge 75 ]]; then
				status="#[fg=#549665]ğŸ”‹"
			elif [[ "$capacity" -le 75 ]] && [[ "$capacity" -ge 50 ]]; then
				status="#[fg=#549665]ï‰‚ "
			elif [[ "$capatity" -le 50 ]] && [[ "$capacity" -ge 20 ]]; then
				status="#[fg=#549665]ï‰ƒ "
			elif [[ "$capatity" -le 20 ]] && [[ "$capacity" -ge 15 ]]; then
				status="#[fg=red]ï‰ƒ "
				notify-send -u critical "Plugin the power cable"
			else
				status="#[fg=red]ï‰„ "
				notify-send -u critical "Plugin the power cable immediately"
			fi
		fi
		[[ ! "$status" = "D" && "$capacity" -gt 85 && $(cat "/sys/class/power_supply/AC/online") = "1" ]] && notify-send -u low "Unplug the power cable"
		printf "%s%d%%" "$status " "$capacity"
	done
}

# ufw(){
#     ufwstatus=$(sudo ufw status | awk '{ print $2 }')
#     if [ "$ufwstatus" = "active" ]; then
#            echo -e "#[fg=#549665]ï€£ #[default]"
#     elif [ "$ufwstatus" = "inactive" ]; then
#           echo -e "#[fg=#d75f5f]ï‚œ  #[default]"
#     fi
# }

# VOLUME="$(amixer get Master | tail -1 | awk '{print substr($4, 2, length($4) - 3)}')"
memory() {
	free -m | awk '/Mem/ {printf "%d MB\n", $3 }'
}

DATE=$(date +"ğŸ“† %d/%m")
UTC=$(date -u +"ğŸŒ %R")
MSK=$(TZ='Europe/Moscow' date +"ğŸ‡·ğŸ‡º %R")
KG=$(TZ='Asia/Bishkek' date +"ğŸ‡°ğŸ‡¬ %R")
PHT=$(TZ='Asia/Manila' date +"ğŸ‡µğŸ‡­ %R")

mac_vpn_status() {
	UTUN=$(ifconfig | grep -E 'utun[0-9]+:' | grep -v utun0 | cut -f1 -d':')
	IPSEC=$(ifconfig | grep -E 'ipsec[0-9]+:' | cut -f1 -d':')

	if [[ $UTUN != "" ]]; then
		for utun in $UTUN; do
			IP=$(ifconfig $utun 2>/dev/null | grep -w inet | cut -d' ' -f2)
			if [[ "$IP" != "" ]]; then
				echo -en "ï€£"
				return
			fi
		done
	fi

	if [[ $IPSEC != "" ]]; then
		for ipsec in $IPSEC; do
			IP=$(ifconfig $utun 2>/dev/null | grep -w inet | cut -d' ' -f2)
			if [[ "$IP" != "" ]]; then
				echo -en "ï€£"
				return
			fi
		done
	fi

	echo -en "ï‚œ"
}

mac_show_battery() {
	echo -en "ğŸ”‹"
	pmset -g batt | grep 'remain' | sed ' s/.*\t\([0-9]*\%\);.* \([0-9]*:[0-9]*\) remaining.*/\1 \2/g'
}

if [[ "$OSTYPE" == "darwin"* ]]; then
	echo -e "$(mac_vpn_status)#[default] $(network)#[default] $DATE $UTC $MSK $KG $PHT $(mac_show_battery)#[default]"
else
	echo -e "$(usbmon)#[default] $(network)#[default] #[fg=colour68]#[fg=colour96]ğŸ $(memory)#[default] $DATE $UTC $MSK $KG $PHT $(battery)#[default] "
fi
